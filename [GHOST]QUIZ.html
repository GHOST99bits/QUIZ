<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz with Timer - Enhanced</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .quiz-container {
            max-width: 1200px;
            margin: auto;
        }
        .card {
            background-color: #1f2937;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
        }
        
        input[type="text"], textarea {
            background-color: #374151;
            color: #f3ffef; 
            border: 1px solid #4b5563;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        .question-list-item {
            color: #d1d5db;
        }
        .question-list-item:hover {
            background-color: #374151;
        }
        .question-list-item.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .question-list::-webkit-scrollbar {
            width: 6px;
        }
        .question-list::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 20px;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(3px);
        }

        .correct-input {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 1px var(--accent-color);
        }
        .color-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 2px solid transparent;
        }
        .color-circle.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); 
        }
        .answer-option-item {
            background-color: #374151;
            border-radius: 8px;
            border: 1px solid #4b5563;
        }
        .correct-btn {
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tab-workspace, #tab-preview {
            background-color: #1f2937;
            color: #9ca3af;
        }
        .tab-active-bg {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
        }

        /* Timer Styles - Fixed Position Lower Left */
        .timer-widget {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background-color: #1f2937;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .timer-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 10px;
        }
        
        .timer-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid;
            transition: border-color 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .timer-ring.blue {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .timer-ring.yellow {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        .timer-ring.red {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulse-red 1s ease-in-out infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% {
                border-color: #ef4444;
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            }
            50% {
                border-color: #dc2626;
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
            }
        }
        
        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .timer-btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .reveal-answer-btn {
            transition: all 0.3s ease;
        }
        
        .revealed-correct {
            background-color: #10b981 !important;
            border-color: #059669 !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        @media (max-width: 640px) {
            .timer-widget {
                bottom: 10px;
                left: 10px;
            }
            .timer-container {
                width: 120px;
                height: 120px;
            }
            .timer-display {
                font-size: 1.5rem;
            }
            .timer-ring {
                border-width: 5px;
            }
        }
    </style>
    <style id="dynamic-styles"></style>
</head>
<body class="p-4 sm:p-6 lg:p-10">

    <div class="quiz-container">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-100 mb-2">Quiz with Timer</h1>
            <p class="text-gray-400 text-sm sm:text-base">Your quiz data is saved locally and optimized for focused editing.</p>
        </header>

        <!-- Quiz Details & Save Status -->
        <div class="card p-5 mb-6">
            <input id="quiz-title" type="text" placeholder="ðŸ“ Enter Quiz Title" class="w-full p-2 text-lg sm:text-xl font-bold border-b border-gray-600 focus:outline-none focus:border-blue-500 mb-3">
            <div class="flex justify-between items-center text-xs sm:text-sm text-gray-400 mt-2 flex-wrap gap-2">
                <span id="save-status" class="font-medium">Loading...</span>
                <span class="font-bold text-green-400">Data Stored Locally</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Left Panel -->
            <div class="w-full lg:w-1/3">
                <div class="card p-5">

                    <div class="mb-6 border-b border-gray-700 pb-4">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-200 mb-2">Success Color Accent</h3>
                        <div id="color-picker-plate" class="flex justify-around space-x-2">
                        </div>
                    </div>

                    <div class="flex flex-col gap-2 mb-4 border-b border-gray-700 pb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-200">Questions (<span id="question-count">0</span>)</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="addQuestion()" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center text-xs sm:text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> New Question
                            </button>
                            <button onclick="openImportModal()" class="p-2 border border-blue-600 text-blue-400 rounded-lg hover:bg-blue-900 transition duration-150 flex items-center justify-center text-xs sm:text-sm font-medium">
                                <i data-lucide="import" class="w-4 h-4 mr-1"></i> Bulk Import
                            </button>
                        </div>
                        <button onclick="confirmDeleteAll()" class="p-2 mt-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center text-xs sm:text-sm font-medium">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Delete ALL
                        </button>
                        <button onclick="openExportModal()" class="p-2 mt-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition duration-150 flex items-center justify-center text-xs sm:text-sm font-medium border border-gray-600">
                            <i data-lucide="download" class="w-4 h-4 mr-1"></i> Export Quiz
                        </button>
                    </div>

                    <ul id="question-list" class="space-y-2 max-h-[60vh] overflow-y-auto question-list pr-1">
                        <li id="empty-list-message" class="text-center text-gray-500 py-4 italic text-sm">Click 'New Question' to begin.</li>
                    </ul>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="w-full lg:w-2/3">
                <div class="card min-h-full">
                    
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-700">
                        <button id="tab-workspace" onclick="setActiveTab('workspace')" class="flex-1 px-4 py-3 text-center text-xs sm:text-sm font-semibold transition duration-150">
                            <i data-lucide="edit-3" class="w-4 h-4 mr-2 inline-block"></i> Workspace
                        </button>
                        <button id="tab-preview" onclick="setActiveTab('preview')" class="flex-1 px-4 py-3 text-center text-xs sm:text-sm font-semibold transition duration-150">
                            <i data-lucide="eye" class="w-4 h-4 mr-2 inline-block"></i> Preview & Test
                        </button>
                    </div>

                    <!-- Editor Content -->
                    <div id="editor-content" class="p-6">
                        <div id="editor-placeholder" class="h-full flex flex-col items-center justify-center text-center text-gray-500 p-12">
                            <i data-lucide="check" class="w-8 h-8 text-blue-500 mb-3"></i>
                            <p class="font-semibold text-sm sm:text-base">Select a question or add a new one to start editing.</p>
                        </div>
        
                        <div id="question-editor-card" class="hidden">
                            <label class="block text-gray-200 font-semibold mb-2 text-sm sm:text-base">Question <span id="current-question-index">1</span></label>
                            
                            <button id="tts-button" onclick="speakQuestion()" class="mb-4 w-full py-2 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition duration-150 flex items-center justify-center text-sm sm:text-base" disabled>
                                <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i> <span>Read Question Text</span>
                            </button>
                            
                            <textarea id="editor-question-text" rows="3" placeholder="Type your question text here..." class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-sm sm:text-base"></textarea>
        
                            <div class="flex items-center justify-between mb-3 border-t border-gray-700 pt-4">
                                <label class="text-xs sm:text-sm font-semibold text-gray-200">Answer Options (Default: 4)</label>
                                <button onclick="addAnswerOption()" class="text-blue-400 hover:text-blue-200 font-medium text-xs sm:text-sm flex items-center transition duration-150">
                                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add Option
                                </button>
                            </div>
                            
                            <div id="answer-options-container" class="space-y-3">
                            </div>
        
                            <button onclick="deleteCurrentQuestion()" class="mt-8 w-full py-2 border border-red-500 text-red-400 font-bold rounded-lg hover:bg-red-900 transition duration-150 flex items-center justify-center text-sm sm:text-base">
                                <i data-lucide="trash2" class="w-4 h-4 mr-2"></i> Delete This Question
                            </button>
                        </div>
                    </div>

                    <!-- Preview Content -->
                    <div id="preview-content" class="p-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4" id="preview-title"></h2>
                        <div id="quiz-preview-container" class="space-y-8">
                        </div>
                        
                        <div id="global-submit-container" class="mt-8 flex justify-center">
                            <button id="submit-quiz-btn" onclick="submitFullQuiz()" class="px-6 sm:px-8 py-3 bg-blue-600 text-white text-base sm:text-lg font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center shadow-lg">
                                <i data-lucide="send" class="w-4 sm:w-5 h-4 sm:h-5 mr-2"></i> Submit Quiz
                            </button>
                        </div>

                        <div id="quiz-score-display" class="mt-8 p-5 card border-2 border-gray-700 text-center">
                            <h3 class="text-lg sm:text-xl font-bold text-gray-200 mb-2">Total Quiz Score</h3>
                            <p class="text-2xl sm:text-3xl text-gray-400 font-extrabold" id="current-score-text">Not Submitted</p>
                            <p class="text-xs sm:text-sm text-gray-500 mt-2">Click "Submit Quiz" above to calculate your result.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeImportModal()"></div>
        <div class="bg-gray-800 card w-full max-w-xl p-6 relative z-10">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 flex items-center">
                <i data-lucide="import" class="w-6 h-6 mr-2 text-blue-400"></i> Bulk Question Importer
            </h2>
            <p class="text-xs sm:text-sm text-gray-400 mb-4">Paste your questions below. Separate questions with a blank line. Mark the correct answer option with a leading asterisk (*).</p>
            
            <textarea id="bulk-input-area" rows="10" placeholder="Example:&#10;What is the capital of France?&#10;- Berlin&#10;* Paris&#10;- Rome&#10;- London&#10;&#10;Question 2 here?&#10;* Answer 1&#10;- Answer 2&#10;- Answer 3&#10;- Answer 4" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs sm:text-sm font-mono"></textarea>

            <div class="flex justify-end gap-3 mt-4">
                <button onclick="closeImportModal()" class="px-4 py-2 border border-gray-600 text-gray-400 rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                    Cancel
                </button>
                <button onclick="processBulkInput()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 text-sm">
                    Import Questions
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeExportModal()"></div>
        <div class="bg-gray-800 card w-full max-w-xl p-6 relative z-10">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 flex items-center">
                <i data-lucide="download" class="w-6 h-6 mr-2 text-blue-400"></i> Export Quiz Text
            </h2>
            <p class="text-xs sm:text-sm text-gray-400 mb-4">Copy the text below to share or save your quiz.</p>
            
            <textarea id="export-output-area" rows="10" readonly class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 focus:outline-none text-xs sm:text-sm font-mono"></textarea>

            <div class="flex justify-end gap-3 mt-4">
                <button onclick="copyExportText()" class="px-4 py-2 border border-blue-600 text-blue-400 rounded-lg hover:bg-blue-900 transition duration-150 text-sm">
                    Copy to Clipboard
                </button>
                <button onclick="closeExportModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Delete All Confirmation Modal -->
    <div id="delete-all-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeDeleteAllModal()"></div>
        <div class="bg-gray-800 card w-full max-w-sm p-6 relative z-10 text-center">
            <h2 class="text-xl font-bold text-gray-100 mb-4">Are you sure?</h2>
            <p class="text-gray-400 mb-6">This will permanently delete all questions on this device.</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeDeleteAllModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 font-bold">
                    NO
                </button>
                <button onclick="deleteAllQuestions()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 font-bold">
                    YES
                </button>
            </div>
        </div>
    </div>

    <script>
        function confirmDeleteAll() {
            document.getElementById('delete-all-modal').classList.remove('hidden');
        }

        function closeDeleteAllModal() {
            document.getElementById('delete-all-modal').classList.add('hidden');
        }

        function deleteAllQuestions() {
            quizData.questions = [];
            hideEditor();
            renderQuizStructure();
            saveQuiz();
            closeDeleteAllModal();
            showNotification('All questions deleted.');
        }

        // Audio Context for beep sound
        let audioContext = null;
        let customAudio = null;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBeepBeep() {
            if (customAudio) {
                customAudio.currentTime = 0;
                customAudio.play().catch(err => console.log('Audio play failed:', err));
            } else {
                initAudioContext();
                playBeep(800, 0, 0.15);
                playBeep(800, 0.2, 0.15);
            }
        }

        function playBeep(frequency, startTime, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
            
            oscillator.start(audioContext.currentTime + startTime);
            oscillator.stop(audioContext.currentTime + startTime + duration);
        }

        function uploadMP3() {
            const fileInput = document.getElementById('mp3-upload');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    customAudio = new Audio(e.target.result);
                    showNotification('Custom MP3 alarm loaded successfully!');
                };
                reader.readAsDataURL(file);
            }
        }

        function adjustTime(seconds) {
            timerSeconds = Math.max(0, Math.min(3600, timerSeconds + seconds));
            updateTimerDisplay();
        }

        // Timer Variables
        let timerSeconds = 60;
        let timerInterval = null;
        let isTimerRunning = false;

        let $timerDisplay, $timerRing, $startBtn, $pauseBtn, $resetBtn;

        function updateTimerDisplay() {
            if (!$timerDisplay || !$timerRing) return;
            
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            $timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Update color based on time
            $timerRing.classList.remove('blue', 'yellow', 'red');
            $timerDisplay.classList.remove('text-blue-400', 'text-yellow-400', 'text-red-400');
            
            if (timerSeconds >= 21) {
                $timerRing.classList.add('blue');
                $timerDisplay.classList.add('text-blue-400');
            } else if (timerSeconds >= 11) {
                $timerRing.classList.add('yellow');
                $timerDisplay.classList.add('text-yellow-400');
            } else {
                $timerRing.classList.add('red');
                $timerDisplay.classList.add('text-red-400');
            }
        }

        function startTimer() {
            if (isTimerRunning) return;
            
            initAudioContext(); // Initialize on user interaction
            isTimerRunning = true;
            $startBtn.disabled = true;
            $pauseBtn.disabled = false;
            
            timerInterval = setInterval(() => {
                if (timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds === 0) {
                        playBeepBeep();
                        pauseTimer();
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            $startBtn.disabled = false;
            $pauseBtn.disabled = true;
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 60;
            updateTimerDisplay();
        }

        // Quiz Application Code
        const STORAGE_KEY = 'fastQuizCreatorData';
        const COLOR_MAP = {
            'Violet': { primary: 'bg-violet-500', border: 'border-violet-600', shadow_hex: '#a78bfa', text: 'text-violet-400' },
            'Green': { primary: 'bg-emerald-500', border: 'border-emerald-600', shadow_hex: '#34d399', text: 'text-emerald-400' },
            'Indigo': { primary: 'bg-indigo-500', border: 'border-indigo-600', shadow_hex: '#818cf8', text: 'text-indigo-400' },
            'Red': { primary: 'bg-red-500', border: 'border-red-600', shadow_hex: '#f87171', text: 'text-red-400' },
        };
        const AVAILABLE_COLORS = Object.keys(COLOR_MAP);
        const OPTION_LABELS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

        let quizData = {
            title: 'New Quiz',
            questions: [],
            accentColor: 'Violet' 
        };
        let currentQuestionIndex = -1; 
        let activeQuestionId = null; 
        let activeTab = 'workspace'; 
        let userAnswers = {};
        let isQuizSubmitted = false;
        let revealedAnswers = {};

        const $titleInput = document.getElementById('quiz-title');
        const $questionList = document.getElementById('question-list');
        const $editorCard = document.getElementById('question-editor-card');
        const $editorPlaceholder = document.getElementById('editor-placeholder');
        const $currentQuestionIndex = document.getElementById('current-question-index');
        const $editorQuestionText = document.getElementById('editor-question-text');
        const $answerOptionsContainer = document.getElementById('answer-options-container');
        const $questionCount = document.getElementById('question-count');
        const $emptyListMessage = document.getElementById('empty-list-message');
        const $saveStatus = document.getElementById('save-status');
        const $importModal = document.getElementById('import-modal');
        const $bulkInputArea = document.getElementById('bulk-input-area');
        const $exportModal = document.getElementById('export-modal');
        const $exportOutputArea = document.getElementById('export-output-area');
        const $colorPickerPlate = document.getElementById('color-picker-plate');
        const $dynamicStyles = document.getElementById('dynamic-styles');
        const $ttsButton = document.getElementById('tts-button');
        const $ttsButtonText = $ttsButton ? $ttsButton.querySelector('span') : null;

        const $tabWorkspace = document.getElementById('tab-workspace');
        const $tabPreview = document.getElementById('tab-preview');
        const $editorContent = document.getElementById('editor-content');
        const $previewContent = document.getElementById('preview-content');

        const $previewTitle = document.getElementById('preview-title');
        const $quizPreviewContainer = document.getElementById('quiz-preview-container');
        const $globalSubmitContainer = document.getElementById('global-submit-container');
        const $submitQuizBtn = document.getElementById('submit-quiz-btn');
        const $quizScoreDisplay = document.getElementById('quiz-score-display');
        const $currentScoreText = document.getElementById('current-score-text');

        const generateUUID = () => crypto.randomUUID();

        function getCorrectOptionId(questionId) {
            const question = quizData.questions.find(q => q.id === questionId);
            return question ? question.options.find(opt => opt.isCorrect)?.id : null;
        }

        function showNotification(message) {
            console.log("Notification:", message);
            const scoreDisplay = document.getElementById('quiz-score-display');
            const p = document.createElement('p');
            p.textContent = message;
            p.className = 'text-amber-400 font-semibold mt-4 p-2 bg-amber-900/50 rounded-lg transition-opacity duration-300';
            scoreDisplay.appendChild(p);
            setTimeout(() => p.remove(), 4000);
        }

        function speakQuestion() {
            const textToRead = $editorQuestionText.value.trim();
            if (!textToRead) {
                showNotification("Please enter question text before attempting to read.");
                return;
            }
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            } else {
                showNotification("Text-to-speech is not supported in your browser.");
            }
        }

        function saveQuiz() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(quizData));
                $saveStatus.textContent = `Saved at ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('Save failed:', e);
                $saveStatus.textContent = 'Save failed';
            }
        }

        function loadQuiz() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    quizData = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Load failed:', e);
            }
            
            $titleInput.value = quizData.title || 'New Quiz';
            renderQuizStructure();
            renderColorPicker();
            updateAccentStyle(quizData.accentColor || 'Violet');
            setActiveTab(activeTab);
            $saveStatus.textContent = 'Loaded successfully';
        }

        function renderColorPicker() {
            $colorPickerPlate.innerHTML = '';
            AVAILABLE_COLORS.forEach(colorName => {
                const colorDef = COLOR_MAP[colorName];
                const circle = document.createElement('div');
                circle.className = `color-circle ${colorDef.primary}`;
                if (colorName === quizData.accentColor) {
                    circle.classList.add('selected');
                }
                circle.setAttribute('data-color', colorName);
                circle.onclick = () => updateAccentStyle(colorName);
                $colorPickerPlate.appendChild(circle);
            });
        }

        function updateAccentStyle(colorName) {
            quizData.accentColor = colorName;
            const colorDef = COLOR_MAP[colorName];
            
            $dynamicStyles.textContent = `
                :root {
                    --accent-color: ${colorDef.shadow_hex};
                }
            `;
            
            renderColorPicker();
            saveQuiz();
        }

        function renderQuizStructure() {
            $questionList.innerHTML = '';
            
            if (quizData.questions.length === 0) {
                $emptyListMessage.classList.remove('hidden');
                $questionList.appendChild($emptyListMessage);
            } else {
                $emptyListMessage.classList.add('hidden');
                quizData.questions.forEach((q, idx) => {
                    const li = document.createElement('li');
                    li.id = `q-item-${q.id}`;
                    li.className = 'question-list-item flex items-center justify-between p-3 rounded-lg cursor-pointer transition duration-150 bg-gray-800 hover:bg-gray-700';
                    
                    const span = document.createElement('span');
                    span.textContent = `Q${idx + 1}: ${q.text || 'Untitled Question'}`;
                    span.className = 'text-sm font-medium truncate';
                    
                    li.appendChild(span);
                    li.onclick = () => selectQuestion(idx, li.id);
                    
                    $questionList.appendChild(li);
                });
            }
            
            $questionCount.textContent = quizData.questions.length;
        }

        function addQuestion() {
            const newQuestion = {
                id: generateUUID(),
                text: '',
                options: [
                    { id: generateUUID(), text: 'Option A', isCorrect: true },
                    { id: generateUUID(), text: 'Option B', isCorrect: false },
                    { id: generateUUID(), text: 'Option C', isCorrect: false },
                    { id: generateUUID(), text: 'Option D', isCorrect: false }
                ]
            };
            
            quizData.questions.push(newQuestion);
            renderQuizStructure();
            
            const newIndex = quizData.questions.length - 1;
            const newItemId = `q-item-${newQuestion.id}`;
            selectQuestion(newIndex, newItemId);
        }

        function selectQuestion(index, listItemId) {
            currentQuestionIndex = index;
            const currentQuestion = quizData.questions[index];
            activeQuestionId = currentQuestion.id;

            document.querySelectorAll('.question-list-item').forEach(li => {
                li.classList.remove('active');
                li.classList.add('bg-gray-800', 'hover:bg-gray-700');
            });
            
            const selectedItem = document.getElementById(listItemId);
            if (selectedItem) {
                selectedItem.classList.add('active');
                selectedItem.classList.remove('bg-gray-800', 'hover:bg-gray-700');
            }

            $editorPlaceholder.classList.add('hidden');
            $editorCard.classList.remove('hidden');
            
            if ($ttsButton) {
                $ttsButton.disabled = false;
            }

            renderQuestionEditor(currentQuestion);
        }

        function renderQuestionEditor(question) {
            $currentQuestionIndex.textContent = currentQuestionIndex + 1;
            $editorQuestionText.value = question.text;
            
            $answerOptionsContainer.innerHTML = '';
            
            question.options.forEach((opt, idx) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'answer-option-item p-3 flex items-center gap-3';
                
                const label = document.createElement('span');
                label.textContent = OPTION_LABELS[idx];
                label.className = 'font-bold text-gray-300 text-sm w-6';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = opt.text;
                input.className = 'option-text-input flex-1 p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm';
                input.setAttribute('data-option-id', opt.id);
                
                if (opt.isCorrect) {
                    input.classList.add('correct-input');
                }
                
                const correctBtn = document.createElement('button');
                correctBtn.className = `correct-btn w-10 h-10 rounded-lg border-2 transition ${
                    opt.isCorrect ? COLOR_MAP[quizData.accentColor].primary : 'bg-gray-600 border-gray-500'
                }`;
                correctBtn.setAttribute('data-option-id', opt.id);
                correctBtn.innerHTML = opt.isCorrect 
                    ? '<i data-lucide="check" class="w-5 h-5 text-white"></i>'
                    : '<span class="text-gray-400 text-xs">Set</span>';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-option-btn text-red-400 hover:text-red-300 transition';
                deleteBtn.setAttribute('data-option-id', opt.id);
                deleteBtn.innerHTML = '<i data-lucide="trash2" class="w-4 h-4"></i>';
                
                if (question.options.length <= 2) {
                    deleteBtn.disabled = true;
                    deleteBtn.classList.add('opacity-30', 'cursor-not-allowed');
                }
                
                optionDiv.appendChild(label);
                optionDiv.appendChild(input);
                optionDiv.appendChild(correctBtn);
                optionDiv.appendChild(deleteBtn);
                
                $answerOptionsContainer.appendChild(optionDiv);
            });
            
            setupOptionListeners();
            lucide.createIcons();
        }

        function hideEditor() {
            currentQuestionIndex = -1;
            activeQuestionId = null;
            $editorCard.classList.add('hidden');
            $editorPlaceholder.classList.remove('hidden');

            if ($ttsButton) {
                $ttsButton.disabled = true;
                if ($ttsButtonText) {
                    $ttsButtonText.textContent = 'Read Question Text';
                }
            }

            document.querySelectorAll('.question-list-item').forEach(li => {
                li.classList.remove('active');
                li.classList.add('bg-gray-800', 'hover:bg-gray-700');
            });
        }

        function deleteCurrentQuestion() {
            if (currentQuestionIndex === -1) return;
            quizData.questions.splice(currentQuestionIndex, 1);
            hideEditor();
            renderQuizStructure();
            saveQuiz();
        }

        function addAnswerOption() {
            if (currentQuestionIndex === -1) return;
            const currentQuestion = quizData.questions[currentQuestionIndex];
            const newOption = {
                id: generateUUID(),
                text: `Option ${OPTION_LABELS[currentQuestion.options.length]}`,
                isCorrect: false
            };
            currentQuestion.options.push(newOption);
            renderQuestionEditor(currentQuestion);
            saveQuiz();
        }

        function setupListeners() {
            $titleInput.addEventListener('input', () => {
                quizData.title = $titleInput.value;
                saveQuiz();
            });

            $editorQuestionText.addEventListener('input', () => {
                if (currentQuestionIndex !== -1) {
                    quizData.questions[currentQuestionIndex].text = $editorQuestionText.value;
                    renderQuizStructure();
                    saveQuiz();
                }
            });
        }

        function setupOptionListeners() {
            $answerOptionsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.correct-btn');
                const delBtn = e.target.closest('.delete-option-btn');
                
                if (btn) {
                    toggleCorrectOption(btn.getAttribute('data-option-id'));
                } else if (delBtn && !delBtn.disabled) {
                    deleteAnswerOption(delBtn.getAttribute('data-option-id'));
                }
            });

            $answerOptionsContainer.addEventListener('input', (e) => {
                const input = e.target.closest('.option-text-input');
                if (input) {
                    updateAnswerText(input.getAttribute('data-option-id'), input.value);
                }
            });
        }

        function toggleCorrectOption(optionId) {
            if (currentQuestionIndex === -1) return;
            const currentQuestion = quizData.questions[currentQuestionIndex];
            
            currentQuestion.options.forEach(opt => {
                opt.isCorrect = (opt.id === optionId);
            });

            renderQuestionEditor(currentQuestion);
            saveQuiz();
        }

        function updateAnswerText(optionId, newText) {
            if (currentQuestionIndex === -1) return;
            const currentQuestion = quizData.questions[currentQuestionIndex];

            const option = currentQuestion.options.find(opt => opt.id === optionId);
            if (option) {
                option.text = newText;
                saveQuiz();
            }
        }

        function deleteAnswerOption(optionId) {
            if (currentQuestionIndex === -1) return;
            const currentQuestion = quizData.questions[currentQuestionIndex];

            if (currentQuestion.options.length <= 2) return;

            const wasCorrect = currentQuestion.options.find(opt => opt.id === optionId)?.isCorrect;
            currentQuestion.options = currentQuestion.options.filter(opt => opt.id !== optionId);
            
            if (wasCorrect && !currentQuestion.options.some(opt => opt.isCorrect)) {
                currentQuestion.options[0].isCorrect = true;
            }

            renderQuestionEditor(currentQuestion);
            saveQuiz();
        }

        function openImportModal() {
            $importModal.classList.remove('hidden');
        }

        function closeImportModal() {
            $importModal.classList.add('hidden');
            $bulkInputArea.value = ''; 
        }

        function processBulkInput() {
            const rawText = $bulkInputArea.value.trim();
            if (!rawText) {
                closeImportModal();
                return;
            }

            const rawQuestions = rawText.split(/\n\s*\n/); 
            const newQuestions = [];

            rawQuestions.forEach(qBlock => {
                const lines = qBlock.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                if (lines.length < 2) return; 

                const questionText = lines[0];
                const rawOptions = lines.slice(1);
                
                const options = rawOptions.map(optText => {
                    const isCorrect = optText.startsWith('*');
                    const text = optText.replace(/^[\*-]\s*/, '');

                    return {
                        id: generateUUID(),
                        text: text,
                        isCorrect: isCorrect
                    };
                });
                
                while (options.length < 4) {
                    options.push({
                        id: generateUUID(),
                        text: `Option ${OPTION_LABELS[options.length]}`,
                        isCorrect: false
                    });
                }
                
                if (!options.some(opt => opt.isCorrect) && options.length > 0) {
                    options[0].isCorrect = true;
                }
                
                newQuestions.push({
                    id: generateUUID(),
                    text: questionText,
                    options: options
                });
            });

            if (newQuestions.length > 0) {
                const startingLength = quizData.questions.length;
                quizData.questions.push(...newQuestions);
                renderQuizStructure(); 

                const newIndex = startingLength;
                const newQuestionId = newQuestions[0].id;
                selectQuestion(newIndex, `q-item-${newQuestionId}`);
            }

            closeImportModal();
        }

        function generateExportText() {
            if (quizData.questions.length === 0) return "";

            const questionBlocks = quizData.questions.map(q => {
                let block = q.text + '\n';
                
                const optionLines = q.options.map(o => {
                    const marker = o.isCorrect ? '*' : '-';
                    return marker + ' ' + o.text;
                });
                
                block += optionLines.join('\n');
                return block;
            });

            return questionBlocks.join('\n\n');
        }

        function openExportModal() {
            const exportText = generateExportText();
            $exportOutputArea.value = exportText;
            $exportModal.classList.remove('hidden');
        }

        function closeExportModal() {
            $exportModal.classList.add('hidden');
        }

        function copyExportText() {
            $exportOutputArea.select();
            document.execCommand('copy');
            const copyButton = document.querySelector('#export-modal button:first-of-type');
            const originalButtonText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalButtonText;
            }, 1500);
        }

        function setActiveTab(tab) {
            activeTab = tab;
            
            if (tab === 'workspace') {
                $tabWorkspace.classList.add('tab-active-bg');
                $tabPreview.classList.remove('tab-active-bg');
                $editorContent.classList.remove('hidden');
                $previewContent.classList.add('hidden');
            } else {
                $tabPreview.classList.add('tab-active-bg');
                $tabWorkspace.classList.remove('tab-active-bg');
                $previewContent.classList.remove('hidden');
                $editorContent.classList.add('hidden');
                renderPreview();
            }
            
            lucide.createIcons();
        }

        function renderPreview() {
            $previewTitle.textContent = quizData.title || 'Untitled Quiz';
            $quizPreviewContainer.innerHTML = '';
            
            if (quizData.questions.length === 0) {
                $quizPreviewContainer.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm sm:text-base">No questions to preview. Add questions in the Workspace tab.</p>';
                $globalSubmitContainer.classList.add('hidden');
                return;
            }
            
            $globalSubmitContainer.classList.remove('hidden');
            
            quizData.questions.forEach((q, qIdx) => {
                const qCard = document.createElement('div');
                qCard.className = 'card p-4 sm:p-6';
                qCard.id = `preview-q-${q.id}`;
                
                const qHeader = document.createElement('div');
                qHeader.className = 'flex justify-between items-start mb-4 gap-4';
                
                const qText = document.createElement('h3');
                qText.className = 'text-base sm:text-lg font-semibold text-gray-100 flex-1';
                qText.textContent = `${qIdx + 1}. ${q.text}`;
                
                const revealBtn = document.createElement('button');
                revealBtn.className = 'reveal-answer-btn px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 flex items-center text-xs sm:text-sm font-medium whitespace-nowrap';
                revealBtn.innerHTML = '<i data-lucide="eye" class="w-4 h-4 mr-1 sm:mr-2"></i> <span>Show Answer</span>';
                revealBtn.onclick = () => revealAnswer(q.id);
                
                qHeader.appendChild(qText);
                qHeader.appendChild(revealBtn);
                qCard.appendChild(qHeader);
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'space-y-2 sm:space-y-3';
                
                q.options.forEach((opt, optIdx) => {
                    const optLabel = document.createElement('label');
                    optLabel.className = 'flex items-center p-3 sm:p-4 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150 border-2 border-transparent';
                    optLabel.id = `preview-opt-${opt.id}`;
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `question-${q.id}`;
                    radio.value = opt.id;
                    radio.className = 'w-4 h-4 sm:w-5 sm:h-5 text-blue-600';
                    radio.onchange = () => recordAnswer(q.id, opt.id);
                    
                    if (userAnswers[q.id] === opt.id) {
                        radio.checked = true;
                    }
                    
                    const optText = document.createElement('span');
                    optText.className = 'ml-3 text-sm sm:text-base text-gray-200 font-medium';
                    optText.textContent = `${OPTION_LABELS[optIdx]}. ${opt.text}`;
                    
                    optLabel.appendChild(radio);
                    optLabel.appendChild(optText);
                    optionsDiv.appendChild(optLabel);
                });
                
                qCard.appendChild(optionsDiv);
                $quizPreviewContainer.appendChild(qCard);
            });
            
            lucide.createIcons();
        }

        function revealAnswer(questionId) {
            const question = quizData.questions.find(q => q.id === questionId);
            if (!question) return;
            
            const correctOption = question.options.find(opt => opt.isCorrect);
            if (!correctOption) return;
            
            const correctOptElement = document.getElementById(`preview-opt-${correctOption.id}`);
            if (correctOptElement) {
                correctOptElement.classList.add('revealed-correct');
                revealedAnswers[questionId] = true;
                
                const qCard = document.getElementById(`preview-q-${questionId}`);
                const revealBtn = qCard.querySelector('.reveal-answer-btn');
                if (revealBtn) {
                    revealBtn.innerHTML = '<i data-lucide="eye-off" class="w-4 h-4 mr-1 sm:mr-2"></i> <span>Answer Shown</span>';
                    revealBtn.disabled = true;
                    revealBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                lucide.createIcons();
            }
        }

        function recordAnswer(questionId, optionId) {
            userAnswers[questionId] = optionId;
        }

        function submitFullQuiz() {
            if (quizData.questions.length === 0) {
                showNotification("No questions to grade!");
                return;
            }
            
            let correctCount = 0;
            const totalQuestions = quizData.questions.length;
            
            quizData.questions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                const correctAnswer = getCorrectOptionId(q.id);
                
                if (userAnswer === correctAnswer) {
                    correctCount++;
                }
            });
            
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            $currentScoreText.textContent = `${correctCount} / ${totalQuestions} (${percentage}%)`;
            
            isQuizSubmitted = true;
            
            $quizScoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        window.onload = () => {
            // Initialize timer elements
            $timerDisplay = document.getElementById('timer-display');
            $timerRing = document.getElementById('timer-ring');
            $startBtn = document.getElementById('start-btn');
            $pauseBtn = document.getElementById('pause-btn');
            $resetBtn = document.getElementById('reset-btn');
            
            loadQuiz();
            setupListeners();
            updateTimerDisplay();
            lucide.createIcons();
        };

        window.addQuestion = addQuestion;
        window.deleteCurrentQuestion = deleteCurrentQuestion;
        window.addAnswerOption = addAnswerOption;
        window.hideEditor = hideEditor;
        window.saveQuiz = saveQuiz;
        window.openImportModal = openImportModal;
        window.closeImportModal = closeImportModal;
        window.processBulkInput = processBulkInput;
        window.openExportModal = openExportModal;
        window.closeExportModal = closeExportModal;
        window.copyExportText = copyExportText;
        window.updateAccentStyle = updateAccentStyle;
        window.setActiveTab = setActiveTab;
        window.recordAnswer = recordAnswer;
        window.submitFullQuiz = submitFullQuiz;
        window.speakQuestion = speakQuestion;
        window.startTimer = startTimer;
        window.pauseTimer = pauseTimer;
        window.resetTimer = resetTimer;
        window.revealAnswer = revealAnswer;

        window.confirmDeleteAll = confirmDeleteAll;
        window.closeDeleteAllModal = closeDeleteAllModal;
        window.deleteAllQuestions = deleteAllQuestions;
        window.adjustTime = adjustTime;
        window.uploadMP3 = uploadMP3;

    </script>

    <!-- Fixed Timer Widget (Lower Left Corner) -->
    <div class="timer-widget">
        <div class="timer-container">
            <div id="timer-ring" class="timer-ring blue"></div>
            <div id="timer-display" class="timer-display text-blue-400">01:00</div>
        </div>
        
        <div class="timer-controls">
            <button id="start-btn" onclick="startTimer()" class="timer-btn bg-green-600 text-white hover:bg-green-700">
                <i data-lucide="play" class="w-3 h-3"></i> Start
            </button>
            <button id="pause-btn" onclick="pauseTimer()" class="timer-btn bg-yellow-600 text-white hover:bg-yellow-700" disabled>
                <i data-lucide="pause" class="w-3 h-3"></i> Pause
            </button>
            <button id="reset-btn" onclick="resetTimer()" class="timer-btn bg-red-600 text-white hover:bg-red-700">
                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset
            </button>
            
            <div class="flex gap-2 mt-2">
                <button onclick="adjustTime(-10)" class="timer-btn flex-1 bg-orange-600 text-white hover:bg-orange-700">
                    -10s
                </button>
                <button onclick="adjustTime(10)" class="timer-btn flex-1 bg-blue-600 text-white hover:bg-blue-700">
                    +10s
                </button>
            </div>
            
            <label class="timer-btn bg-purple-600 text-white hover:bg-purple-700 cursor-pointer mt-2">
                <i data-lucide="music" class="w-3 h-3"></i> MP3
                <input type="file" id="mp3-upload" accept="audio/mp3,audio/mpeg" onchange="uploadMP3()" class="hidden">
            </label>
        </div>
    </div>

</body>
</html>
